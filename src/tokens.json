[
  "import",
  " ",
  "dotenv",
  " ",
  "from",
  " ",
  "\"dotenv\"",
  ";",
  "\n",
  "import",
  " ",
  "express",
  ",",
  " ",
  "{",
  " ",
  "Request",
  ",",
  " ",
  "RequestHandler",
  ",",
  " ",
  "Response",
  " ",
  "}",
  " ",
  "from",
  " ",
  "\"express\"",
  ";",
  "\n",
  "import",
  " ",
  "{",
  " ",
  "OpenAI",
  " ",
  "}",
  " ",
  "from",
  " ",
  "\"llamaindex\"",
  ";",
  "\n",
  "import",
  " ",
  "{",
  "\n",
  "  ",
  "Workflow",
  ",",
  "\n",
  "  ",
  "StartEvent",
  ",",
  "\n",
  "  ",
  "StopEvent",
  ",",
  "\n",
  "  ",
  "WorkflowEvent",
  ",",
  "\n",
  "}",
  " ",
  "from",
  " ",
  "\"@llamaindex",
  "/",
  "workflow\"",
  ";",
  "\n",
  "import",
  " ",
  "authRoutes",
  " ",
  "from",
  " ",
  "\"",
  ".",
  "/",
  "routes",
  "/",
  "auth",
  ".",
  "route\"",
  ";",
  "\n",
  "import",
  " ",
  "tokenizeCode",
  " ",
  "from",
  " ",
  "\"",
  ".",
  "/",
  "tokenizer\"",
  ";",
  "\n",
  "import",
  " ",
  "generateCodebaseIndex",
  " ",
  "from",
  " ",
  "\"",
  ".",
  "/",
  "codeTokenizer\"",
  ";",
  "\n",
  "import",
  " ",
  "fs",
  " ",
  "from",
  " ",
  "\"fs\"",
  ";",
  "\n",
  "import",
  " ",
  "path",
  " ",
  "from",
  " ",
  "\"path\"",
  ";",
  "\n",
  "import",
  " ",
  "{",
  " ",
  "MetadataFilters",
  ",",
  " ",
  "VectorStoreIndex",
  ",",
  " ",
  "Document",
  ",",
  " ",
  "storageContextFromDefaults",
  " ",
  "}",
  " ",
  "from",
  " ",
  "\"llamaindex\"",
  ";",
  "\n",
  "import",
  " ",
  "{",
  " ",
  "ChromaVectorStore",
  " ",
  "}",
  " ",
  "from",
  " ",
  "\"@llamaindex",
  "/",
  "chroma\"",
  ";",
  "\n",
  "\n",
  "dotenv",
  ".",
  "config",
  "(",
  ")",
  ";",
  "\n",
  "\n",
  "/",
  "/",
  " ",
  "Create",
  " ",
  "LLM",
  " ",
  "instance",
  "\n",
  "const",
  " ",
  "llm",
  " ",
  "=",
  " ",
  "new",
  " ",
  "OpenAI",
  "(",
  "{",
  "\n",
  "  ",
  "apiKey",
  ":",
  " ",
  "process",
  ".",
  "env",
  ".",
  "OPENAI_API_KEY",
  ",",
  "\n",
  "  ",
  "model",
  ":",
  " ",
  "\"gpt",
  "-",
  "4o",
  "-",
  "mini\"",
  ",",
  "\n",
  "  ",
  "temperature",
  ":",
  " ",
  "1",
  ",",
  "\n",
  "}",
  ")",
  ";",
  "\n",
  "const",
  " ",
  "collectionName",
  " ",
  "=",
  " ",
  "\"code",
  "-",
  "data\"",
  "\n",
  "\n",
  "const",
  " ",
  "app",
  " ",
  "=",
  " ",
  "express",
  "(",
  ")",
  ";",
  "\n",
  "const",
  " ",
  "port",
  " ",
  "=",
  " ",
  "3000",
  ";",
  "\n",
  "\n",
  "app",
  ".",
  "use",
  "(",
  "express",
  ".",
  "json",
  "(",
  ")",
  ")",
  ";",
  "\n",
  "\n",
  "/",
  "/",
  " ",
  "Modify",
  " ",
  "the",
  " ",
  "connectChromaDb",
  " ",
  "function",
  " ",
  "to",
  " ",
  "store",
  " ",
  "and",
  " ",
  "manage",
  " ",
  "code",
  " ",
  "tokens",
  "\n",
  "async",
  " ",
  "function",
  " ",
  "connectChromaDb",
  "(",
  "collectionName",
  ":",
  " ",
  "string",
  ")",
  " ",
  "{",
  "\n",
  "  ",
  "const",
  " ",
  "chromaVS",
  " ",
  "=",
  " ",
  "new",
  " ",
  "ChromaVectorStore",
  "(",
  "{",
  " ",
  "collectionName",
  " ",
  "}",
  ")",
  ";",
  "\n",
  "  ",
  "const",
  " ",
  "ctx",
  " ",
  "=",
  " ",
  "await",
  " ",
  "storageContextFromDefaults",
  "(",
  "{",
  " ",
  "vectorStore",
  ":",
  " ",
  "chromaVS",
  " ",
  "}",
  ")",
  ";",
  "\n",
  "\n",
  "  ",
  "const",
  " ",
  "storeCodeTokens",
  " ",
  "=",
  " ",
  "async",
  " ",
  "(",
  "fileData",
  ":",
  " ",
  "TokenizedFile",
  ")",
  " ",
  "=",
  ">",
  " ",
  "{",
  "\n",
  "    ",
  "try",
  " ",
  "{",
  "\n",
  "      ",
  "/",
  "/",
  " ",
  "Convert",
  " ",
  "tokens",
  " ",
  "and",
  " ",
  "codeBlocks",
  " ",
  "to",
  " ",
  "Documents",
  "\n",
  "      ",
  "const",
  " ",
  "docs",
  " ",
  "=",
  " ",
  "[",
  "\n",
  "        ",
  ".",
  ".",
  ".",
  "fileData",
  ".",
  "tokens",
  ".",
  "map",
  "(",
  "(",
  "token",
  ",",
  " ",
  "idx",
  ")",
  " ",
  "=",
  ">",
  "\n",
  "          ",
  "new",
  " ",
  "Document",
  "(",
  "{",
  "\n",
  "            ",
  "id_",
  ":",
  " ",
  "`$",
  "{",
  "fileData",
  ".",
  "filePath",
  "}",
  "-",
  "token",
  "-",
  "$",
  "{",
  "idx",
  "}",
  "`",
  ",",
  "\n",
  "            ",
  "text",
  ":",
  " ",
  "JSON",
  ".",
  "stringify",
  "(",
  "token",
  ")",
  ",",
  "\n",
  "            ",
  "metadata",
  ":",
  " ",
  "{",
  "\n",
  "              ",
  "filePath",
  ":",
  " ",
  "fileData",
  ".",
  "filePath",
  ",",
  "\n",
  "              ",
  "type",
  ":",
  " ",
  "'token'",
  ",",
  "\n",
  "              ",
  "lineCount",
  ":",
  " ",
  "fileData",
  ".",
  "lineCount",
  "\n",
  "            ",
  "}",
  "\n",
  "          ",
  "}",
  ")",
  "\n",
  "        ",
  ")",
  ",",
  "\n",
  "        ",
  ".",
  ".",
  ".",
  "fileData",
  ".",
  "codeBlocks",
  ".",
  "map",
  "(",
  "(",
  "block",
  ",",
  " ",
  "idx",
  ")",
  " ",
  "=",
  ">",
  "\n",
  "          ",
  "new",
  " ",
  "Document",
  "(",
  "{",
  "\n",
  "            ",
  "id_",
  ":",
  " ",
  "`$",
  "{",
  "fileData",
  ".",
  "filePath",
  "}",
  "-",
  "block",
  "-",
  "$",
  "{",
  "idx",
  "}",
  "`",
  ",",
  "\n",
  "            ",
  "text",
  ":",
  " ",
  "JSON",
  ".",
  "stringify",
  "(",
  "block",
  ")",
  ",",
  "\n",
  "            ",
  "metadata",
  ":",
  " ",
  "{",
  "\n",
  "              ",
  "filePath",
  ":",
  " ",
  "fileData",
  ".",
  "filePath",
  ",",
  "\n",
  "              ",
  "type",
  ":",
  " ",
  "'codeBlock'",
  ",",
  "\n",
  "              ",
  "lineCount",
  ":",
  " ",
  "fileData",
  ".",
  "lineCount",
  "\n",
  "            ",
  "}",
  "\n",
  "          ",
  "}",
  ")",
  "\n",
  "        ",
  ")",
  "\n",
  "      ",
  "]",
  ";",
  "\n",
  "\n",
  "      ",
  "/",
  "/",
  " ",
  "Create",
  " ",
  "index",
  " ",
  "and",
  " ",
  "store",
  " ",
  "documents",
  "\n",
  "      ",
  "const",
  " ",
  "index",
  " ",
  "=",
  " ",
  "await",
  " ",
  "VectorStoreIndex",
  ".",
  "fromDocuments",
  "(",
  "docs",
  ",",
  " ",
  "{",
  "\n",
  "        ",
  "storageContext",
  ":",
  " ",
  "ctx",
  ",",
  "\n",
  "      ",
  "}",
  ")",
  ";",
  "\n",
  "\n",
  "      ",
  "return",
  " ",
  "index",
  ";",
  "\n",
  "    ",
  "}",
  " ",
  "catch",
  " ",
  "(",
  "error",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "console",
  ".",
  "error",
  "(",
  "\"Error",
  " ",
  "storing",
  " ",
  "tokens",
  ":",
  "\"",
  ",",
  " ",
  "error",
  ")",
  ";",
  "\n",
  "      ",
  "return",
  " ",
  "null",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "  ",
  "}",
  ";",
  "\n",
  "\n",
  "  ",
  "const",
  " ",
  "queryTokens",
  " ",
  "=",
  " ",
  "async",
  " ",
  "(",
  "filters",
  "?",
  ":",
  " ",
  "MetadataFilters",
  ")",
  " ",
  "=",
  ">",
  " ",
  "{",
  "\n",
  "    ",
  "try",
  " ",
  "{",
  "\n",
  "      ",
  "const",
  " ",
  "index",
  " ",
  "=",
  " ",
  "await",
  " ",
  "VectorStoreIndex",
  ".",
  "fromVectorStore",
  "(",
  "chromaVS",
  ")",
  ";",
  "\n",
  "      ",
  "const",
  " ",
  "queryEngine",
  " ",
  "=",
  " ",
  "index",
  ".",
  "asQueryEngine",
  "(",
  "{",
  "\n",
  "        ",
  "preFilters",
  ":",
  " ",
  "filters",
  ",",
  "\n",
  "        ",
  "similarityTopK",
  ":",
  " ",
  "10",
  ",",
  "\n",
  "      ",
  "}",
  ")",
  ";",
  "\n",
  "      ",
  "const",
  " ",
  "response",
  " ",
  "=",
  " ",
  "await",
  " ",
  "queryEngine",
  ".",
  "query",
  "(",
  "{",
  "\n",
  "        ",
  "query",
  ":",
  " ",
  "filters",
  "?",
  ".",
  "query",
  " ",
  "|",
  "|",
  " ",
  "\"List",
  " ",
  "all",
  " ",
  "code",
  " ",
  "tokens\"",
  "\n",
  "      ",
  "}",
  ")",
  ";",
  "\n",
  "      ",
  "return",
  " ",
  "response",
  ";",
  "\n",
  "    ",
  "}",
  " ",
  "catch",
  " ",
  "(",
  "error",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "console",
  ".",
  "error",
  "(",
  "\"Error",
  " ",
  "querying",
  " ",
  "tokens",
  ":",
  "\"",
  ",",
  " ",
  "error",
  ")",
  ";",
  "\n",
  "      ",
  "throw",
  " ",
  "error",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "  ",
  "}",
  ";",
  "\n",
  "\n",
  "  ",
  "return",
  " ",
  "{",
  "\n",
  "    ",
  "vectorStore",
  ":",
  " ",
  "chromaVS",
  ",",
  "\n",
  "    ",
  "storeCodeTokens",
  ",",
  "\n",
  "    ",
  "queryTokens",
  ",",
  "\n",
  "    ",
  "queryFn",
  ":",
  " ",
  "queryTokens",
  "\n",
  "  ",
  "}",
  ";",
  "\n",
  "}",
  "\n",
  "\n",
  "/",
  "/",
  " ",
  "Initialize",
  " ",
  "ChromaDB",
  " ",
  "connection",
  "\n",
  "let",
  " ",
  "chromaClient",
  ":",
  " ",
  "Awaited",
  "<",
  "ReturnType",
  "<",
  "typeof",
  " ",
  "connectChromaDb",
  ">",
  ">",
  ";",
  "\n",
  "\n",
  "app",
  ".",
  "get",
  "(",
  "'",
  "/",
  "api",
  "/",
  "query'",
  ",",
  " ",
  "async",
  " ",
  "(",
  "req",
  ",",
  " ",
  "res",
  ")",
  " ",
  "=",
  ">",
  " ",
  "{",
  "\n",
  "  ",
  "try",
  " ",
  "{",
  "\n",
  "    ",
  "if",
  " ",
  "(",
  "!",
  "chromaClient",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "chromaClient",
  " ",
  "=",
  " ",
  "await",
  " ",
  "connectChromaDb",
  "(",
  "collectionName",
  ")",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "    ",
  "const",
  " ",
  "filters",
  " ",
  "=",
  " ",
  "req",
  ".",
  "query",
  ".",
  "filters",
  " ",
  "?",
  " ",
  "JSON",
  ".",
  "parse",
  "(",
  "String",
  "(",
  "req",
  ".",
  "query",
  ".",
  "filters",
  ")",
  ")",
  " ",
  ":",
  " ",
  "undefined",
  ";",
  "\n",
  "    ",
  "const",
  " ",
  "response",
  " ",
  "=",
  " ",
  "await",
  " ",
  "chromaClient",
  ".",
  "queryFn",
  "(",
  "filters",
  ")",
  ";",
  "\n",
  "    ",
  "res",
  ".",
  "json",
  "(",
  "response",
  ")",
  ";",
  "\n",
  "  ",
  "}",
  " ",
  "catch",
  " ",
  "(",
  "error",
  ")",
  " ",
  "{",
  "\n",
  "    ",
  "res",
  ".",
  "status",
  "(",
  "500",
  ")",
  ".",
  "json",
  "(",
  "{",
  " ",
  "error",
  ":",
  " ",
  "'Error",
  " ",
  "querying",
  " ",
  "the",
  " ",
  "database'",
  " ",
  "}",
  ")",
  ";",
  "\n",
  "  ",
  "}",
  "\n",
  "}",
  ")",
  ";",
  "\n",
  "\n",
  "/",
  "/",
  " ",
  "Add",
  " ",
  "auth",
  " ",
  "routes",
  "\n",
  "app",
  ".",
  "use",
  "(",
  "\"",
  "/",
  "api",
  "/",
  "auth\"",
  ",",
  " ",
  "authRoutes",
  ")",
  ";",
  "\n",
  "\n",
  "/",
  "/",
  " ",
  "Define",
  " ",
  "interface",
  " ",
  "for",
  " ",
  "file",
  " ",
  "data",
  "\n",
  "interface",
  " ",
  "TokenizedFile",
  " ",
  "{",
  "\n",
  "  ",
  "filePath",
  ":",
  " ",
  "string",
  ";",
  "\n",
  "  ",
  "lineCount",
  ":",
  " ",
  "number",
  ";",
  "\n",
  "  ",
  "functionLocations",
  ":",
  " ",
  "any",
  "[",
  "]",
  ";",
  "\n",
  "  ",
  "routeDefinitions",
  ":",
  " ",
  "any",
  "[",
  "]",
  ";",
  "\n",
  "  ",
  "tokens",
  ":",
  " ",
  "any",
  "[",
  "]",
  ";",
  "\n",
  "  ",
  "codeBlocks",
  ":",
  " ",
  "any",
  "[",
  "]",
  ";",
  "\n",
  "}",
  "\n",
  "\n",
  "/",
  "/",
  " ",
  "Modify",
  " ",
  "the",
  " ",
  "loadCodebaseIndex",
  " ",
  "function",
  " ",
  "to",
  " ",
  "store",
  " ",
  "data",
  " ",
  "in",
  " ",
  "ChromaDB",
  "\n",
  "async",
  " ",
  "function",
  " ",
  "loadCodebaseIndex",
  "(",
  ")",
  " ",
  "{",
  "\n",
  "  ",
  "const",
  " ",
  "mdPath",
  " ",
  "=",
  " ",
  "path",
  ".",
  "join",
  "(",
  "__dirname",
  ",",
  " ",
  "\"codebase",
  "-",
  "index",
  ".",
  "md\"",
  ")",
  ";",
  "\n",
  "  ",
  "const",
  " ",
  "jsonPath",
  " ",
  "=",
  " ",
  "path",
  ".",
  "join",
  "(",
  "__dirname",
  ",",
  " ",
  "\"codebase",
  "-",
  "index",
  ".",
  "json\"",
  ")",
  ";",
  "\n",
  "\n",
  "  ",
  "if",
  " ",
  "(",
  "!",
  "fs",
  ".",
  "existsSync",
  "(",
  "mdPath",
  ")",
  " ",
  "|",
  "|",
  " ",
  "!",
  "fs",
  ".",
  "existsSync",
  "(",
  "jsonPath",
  ")",
  ")",
  " ",
  "{",
  "\n",
  "    ",
  "console",
  ".",
  "log",
  "(",
  "\"Generating",
  " ",
  "codebase",
  " ",
  "index",
  " ",
  "files",
  ".",
  ".",
  ".",
  "\"",
  ")",
  ";",
  "\n",
  "    ",
  "generateCodebaseIndex",
  "(",
  ")",
  ";",
  "\n",
  "  ",
  "}",
  "\n",
  "\n",
  "  ",
  "try",
  " ",
  "{",
  "\n",
  "    ",
  "const",
  " ",
  "mdContent",
  " ",
  "=",
  " ",
  "fs",
  ".",
  "readFileSync",
  "(",
  "mdPath",
  ",",
  " ",
  "\"utf",
  "-",
  "8\"",
  ")",
  ";",
  "\n",
  "    ",
  "const",
  " ",
  "jsonContent",
  " ",
  "=",
  " ",
  "JSON",
  ".",
  "parse",
  "(",
  "fs",
  ".",
  "readFileSync",
  "(",
  "jsonPath",
  ",",
  " ",
  "\"utf",
  "-",
  "8\"",
  ")",
  ")",
  ";",
  "\n",
  "\n",
  "    ",
  "if",
  " ",
  "(",
  "!",
  "chromaClient",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "chromaClient",
  " ",
  "=",
  " ",
  "await",
  " ",
  "connectChromaDb",
  "(",
  "collectionName",
  ")",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "\n",
  "    ",
  "/",
  "/",
  " ",
  "Store",
  " ",
  "each",
  " ",
  "file's",
  " ",
  "tokens",
  " ",
  "in",
  " ",
  "ChromaDB",
  "\n",
  "    ",
  "for",
  " ",
  "(",
  "const",
  " ",
  "fileData",
  " ",
  "of",
  " ",
  "jsonContent",
  ".",
  "files",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "await",
  " ",
  "chromaClient",
  ".",
  "storeCodeTokens",
  "(",
  "fileData",
  ")",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "\n",
  "    ",
  "return",
  " ",
  "{",
  "\n",
  "      ",
  "markdown",
  ":",
  " ",
  "mdContent",
  ",",
  "\n",
  "      ",
  "json",
  ":",
  " ",
  "jsonContent",
  ",",
  "\n",
  "    ",
  "}",
  ";",
  "\n",
  "  ",
  "}",
  " ",
  "catch",
  " ",
  "(",
  "error",
  ")",
  " ",
  "{",
  "\n",
  "    ",
  "console",
  ".",
  "error",
  "(",
  "\"Error",
  " ",
  "loading",
  " ",
  "codebase",
  " ",
  "index",
  ":",
  "\"",
  ",",
  " ",
  "error",
  ")",
  ";",
  "\n",
  "    ",
  "return",
  " ",
  "null",
  ";",
  "\n",
  "  ",
  "}",
  "\n",
  "}",
  "\n",
  "\n",
  "/",
  "/",
  " ",
  "Modify",
  " ",
  "the",
  " ",
  "API",
  " ",
  "endpoint",
  " ",
  "to",
  " ",
  "support",
  " ",
  "more",
  " ",
  "complex",
  " ",
  "filters",
  "\n",
  "app",
  ".",
  "get",
  "(",
  "'",
  "/",
  "api",
  "/",
  "tokens'",
  ",",
  " ",
  "async",
  " ",
  "(",
  "req",
  ":",
  " ",
  "Request",
  ",",
  " ",
  "res",
  ":",
  " ",
  "Response",
  ")",
  " ",
  "=",
  ">",
  " ",
  "{",
  "\n",
  "  ",
  "try",
  " ",
  "{",
  "\n",
  "    ",
  "if",
  " ",
  "(",
  "!",
  "chromaClient",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "chromaClient",
  " ",
  "=",
  " ",
  "await",
  " ",
  "connectChromaDb",
  "(",
  "collectionName",
  ")",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "\n",
  "    ",
  "const",
  " ",
  "filters",
  ":",
  " ",
  "MetadataFilters",
  " ",
  "=",
  " ",
  "{",
  "\n",
  "      ",
  "filters",
  ":",
  " ",
  "[",
  "]",
  "\n",
  "    ",
  "}",
  ";",
  "\n",
  "\n",
  "    ",
  "/",
  "/",
  " ",
  "Add",
  " ",
  "file",
  " ",
  "path",
  " ",
  "filter",
  " ",
  "if",
  " ",
  "provided",
  "\n",
  "    ",
  "if",
  " ",
  "(",
  "req",
  ".",
  "query",
  ".",
  "filePath",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "filters",
  ".",
  "filters",
  ".",
  "push",
  "(",
  "{",
  "\n",
  "        ",
  "key",
  ":",
  " ",
  "\"filePath\"",
  ",",
  "\n",
  "        ",
  "value",
  ":",
  " ",
  "req",
  ".",
  "query",
  ".",
  "filePath",
  " ",
  "as",
  " ",
  "string",
  ",",
  "\n",
  "        ",
  "operator",
  ":",
  " ",
  "\"",
  "=",
  "=",
  "\"",
  "\n",
  "      ",
  "}",
  ")",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "\n",
  "    ",
  "/",
  "/",
  " ",
  "Add",
  " ",
  "type",
  " ",
  "filter",
  " ",
  "if",
  " ",
  "provided",
  "\n",
  "    ",
  "if",
  " ",
  "(",
  "req",
  ".",
  "query",
  ".",
  "type",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "filters",
  ".",
  "filters",
  ".",
  "push",
  "(",
  "{",
  "\n",
  "        ",
  "key",
  ":",
  " ",
  "\"type\"",
  ",",
  "\n",
  "        ",
  "value",
  ":",
  " ",
  "req",
  ".",
  "query",
  ".",
  "type",
  " ",
  "as",
  " ",
  "string",
  ",",
  "\n",
  "        ",
  "operator",
  ":",
  " ",
  "\"",
  "=",
  "=",
  "\"",
  "\n",
  "      ",
  "}",
  ")",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "\n",
  "    ",
  "/",
  "/",
  " ",
  "Add",
  " ",
  "condition",
  " ",
  "if",
  " ",
  "multiple",
  " ",
  "filters",
  "\n",
  "    ",
  "if",
  " ",
  "(",
  "filters",
  ".",
  "filters",
  ".",
  "length",
  " ",
  ">",
  " ",
  "1",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "filters",
  ".",
  "condition",
  " ",
  "=",
  " ",
  "\"and\"",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "\n",
  "    ",
  "const",
  " ",
  "response",
  " ",
  "=",
  " ",
  "await",
  " ",
  "chromaClient",
  ".",
  "queryTokens",
  "(",
  "{",
  "\n",
  "      ",
  ".",
  ".",
  ".",
  "filters",
  ",",
  "\n",
  "      ",
  "query",
  ":",
  " ",
  "req",
  ".",
  "query",
  ".",
  "query",
  " ",
  "as",
  " ",
  "string",
  "\n",
  "    ",
  "}",
  ")",
  ";",
  "\n",
  "\n",
  "    ",
  "res",
  ".",
  "json",
  "(",
  "response",
  ")",
  ";",
  "\n",
  "  ",
  "}",
  " ",
  "catch",
  " ",
  "(",
  "error",
  ")",
  " ",
  "{",
  "\n",
  "    ",
  "res",
  ".",
  "status",
  "(",
  "500",
  ")",
  ".",
  "json",
  "(",
  "{",
  " ",
  "error",
  ":",
  " ",
  "'Error",
  " ",
  "querying",
  " ",
  "tokens'",
  " ",
  "}",
  ")",
  ";",
  "\n",
  "  ",
  "}",
  "\n",
  "}",
  ")",
  ";",
  "\n",
  "\n",
  "/",
  "/",
  " ",
  "Define",
  " ",
  "route",
  " ",
  "handlers",
  "\n",
  "const",
  " ",
  "homeHandler",
  " ",
  "=",
  " ",
  "async",
  " ",
  "(",
  "req",
  ":",
  " ",
  "Request",
  ",",
  " ",
  "res",
  ":",
  " ",
  "Response",
  ")",
  " ",
  "=",
  ">",
  " ",
  "{",
  "\n",
  "  ",
  "try",
  " ",
  "{",
  "\n",
  "    ",
  "/",
  "/",
  " ",
  "Load",
  " ",
  "codebase",
  " ",
  "index",
  "\n",
  "    ",
  "const",
  " ",
  "codebaseIndex",
  " ",
  "=",
  " ",
  "await",
  " ",
  "loadCodebaseIndex",
  "(",
  ")",
  ";",
  "\n",
  "\n",
  "    ",
  "if",
  " ",
  "(",
  "!",
  "codebaseIndex",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "return",
  " ",
  "res",
  ".",
  "status",
  "(",
  "500",
  ")",
  ".",
  "json",
  "(",
  "{",
  " ",
  "error",
  ":",
  " ",
  "\"Failed",
  " ",
  "to",
  " ",
  "load",
  " ",
  "codebase",
  " ",
  "index\"",
  " ",
  "}",
  ")",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "\n",
  "    ",
  "/",
  "/",
  " ",
  "Get",
  " ",
  "token",
  " ",
  "data",
  " ",
  "specifically",
  " ",
  "for",
  " ",
  "index",
  ".",
  "ts",
  " ",
  "file",
  "\n",
  "    ",
  "const",
  " ",
  "indexFileData",
  " ",
  "=",
  " ",
  "codebaseIndex",
  ".",
  "json",
  ".",
  "files",
  ".",
  "find",
  "(",
  "(",
  "file",
  ":",
  " ",
  "TokenizedFile",
  ")",
  " ",
  "=",
  ">",
  "\n",
  "      ",
  "file",
  ".",
  "filePath",
  ".",
  "endsWith",
  "(",
  "\"",
  "/",
  "index",
  ".",
  "ts\"",
  ")",
  "\n",
  "    ",
  ")",
  ";",
  "\n",
  "\n",
  "    ",
  "res",
  ".",
  "json",
  "(",
  "{",
  "\n",
  "      ",
  "message",
  ":",
  " ",
  "\"API",
  " ",
  "is",
  " ",
  "running\"",
  ",",
  "\n",
  "      ",
  "indexFile",
  ":",
  " ",
  "{",
  "\n",
  "        ",
  "path",
  ":",
  " ",
  "indexFileData",
  "?",
  ".",
  "filePath",
  ",",
  "\n",
  "        ",
  "lineCount",
  ":",
  " ",
  "indexFileData",
  "?",
  ".",
  "lineCount",
  ",",
  "\n",
  "        ",
  "functionCount",
  ":",
  " ",
  "indexFileData",
  "?",
  ".",
  "functionLocations",
  ".",
  "length",
  ",",
  "\n",
  "        ",
  "routeCount",
  ":",
  " ",
  "indexFileData",
  "?",
  ".",
  "routeDefinitions",
  ".",
  "length",
  ",",
  "\n",
  "        ",
  "tokenCount",
  ":",
  " ",
  "indexFileData",
  "?",
  ".",
  "tokens",
  ".",
  "length",
  ",",
  "\n",
  "      ",
  "}",
  ",",
  "\n",
  "    ",
  "}",
  ")",
  ";",
  "\n",
  "  ",
  "}",
  " ",
  "catch",
  " ",
  "(",
  "error",
  ")",
  " ",
  "{",
  "\n",
  "    ",
  "res",
  ".",
  "status",
  "(",
  "500",
  ")",
  ".",
  "json",
  "(",
  "{",
  " ",
  "error",
  ":",
  " ",
  "\"Error",
  " ",
  "processing",
  " ",
  "request\"",
  " ",
  "}",
  ")",
  ";",
  "\n",
  "  ",
  "}",
  "\n",
  "}",
  ";",
  "\n",
  "\n",
  "const",
  " ",
  "codeQueryHandler",
  " ",
  "=",
  " ",
  "async",
  " ",
  "(",
  "req",
  ":",
  " ",
  "Request",
  ",",
  " ",
  "res",
  ":",
  " ",
  "Response",
  ")",
  " ",
  "=",
  ">",
  " ",
  "{",
  "\n",
  "  ",
  "try",
  " ",
  "{",
  "\n",
  "    ",
  "const",
  " ",
  "{",
  " ",
  "query",
  " ",
  "=",
  " ",
  "\"What",
  " ",
  "is",
  " ",
  "the",
  " ",
  "main",
  " ",
  "function",
  " ",
  "in",
  " ",
  "the",
  " ",
  "index",
  ".",
  "ts",
  " ",
  "file",
  "?",
  "\"",
  " ",
  "}",
  " ",
  "=",
  " ",
  "req",
  ".",
  "body",
  ";",
  "\n",
  "\n",
  "    ",
  "if",
  " ",
  "(",
  "!",
  "query",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "return",
  " ",
  "res",
  ".",
  "status",
  "(",
  "400",
  ")",
  ".",
  "json",
  "(",
  "{",
  " ",
  "error",
  ":",
  " ",
  "\"Query",
  " ",
  "is",
  " ",
  "required\"",
  " ",
  "}",
  ")",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "\n",
  "    ",
  "/",
  "/",
  " ",
  "Load",
  " ",
  "codebase",
  " ",
  "index",
  "\n",
  "    ",
  "const",
  " ",
  "codebaseIndex",
  " ",
  "=",
  " ",
  "await",
  " ",
  "loadCodebaseIndex",
  "(",
  ")",
  ";",
  "\n",
  "\n",
  "    ",
  "if",
  " ",
  "(",
  "!",
  "codebaseIndex",
  ")",
  " ",
  "{",
  "\n",
  "      ",
  "return",
  " ",
  "res",
  ".",
  "status",
  "(",
  "500",
  ")",
  ".",
  "json",
  "(",
  "{",
  " ",
  "error",
  ":",
  " ",
  "\"Failed",
  " ",
  "to",
  " ",
  "load",
  " ",
  "codebase",
  " ",
  "index\"",
  " ",
  "}",
  ")",
  ";",
  "\n",
  "    ",
  "}",
  "\n",
  "\n",
  "    ",
  "/",
  "/",
  " ",
  "Create",
  " ",
  "prompt",
  " ",
  "with",
  " ",
  "markdown",
  " ",
  "context",
  "\n",
  "    ",
  "const",
  " ",
  "prompt",
  " ",
  "=",
  " ",
  "`",
  "\n",
  "You",
  " ",
  "are",
  " ",
  "a",
  " ",
  "code",
  " ",
  "assistant",
  " ",
  "with",
  " ",
  "access",
  " ",
  "to",
  " ",
  "the",
  " ",
  "codebase",
  " ",
  "structure",
  " ",
  "below",
  ".",
  "\n",
  "Answer",
  " ",
  "the",
  " ",
  "following",
  " ",
  "question",
  " ",
  "using",
  " ",
  "the",
  " ",
  "provided",
  " ",
  "code",
  " ",
  "context",
  ":",
  "\n",
  "\n",
  "QUESTION",
  ":",
  " ",
  "$",
  "{",
  "query",
  "}",
  "\n",
  "\n",
  "CODE",
  " ",
  "CONTEXT",
  ":",
  "\n",
  "$",
  "{",
  "codebaseIndex",
  ".",
  "markdown",
  ".",
  "slice",
  "(",
  "0",
  ",",
  " ",
  "15000",
  ")",
  "}",
  "\n",
  "`",
  ";",
  "\n",
  "\n",
  "    ",
  "const",
  " ",
  "response",
  " ",
  "=",
  " ",
  "await",
  " ",
  "llm",
  ".",
  "complete",
  "(",
  "{",
  "\n",
  "      ",
  "prompt",
  ":",
  " ",
  "prompt",
  ",",
  "\n",
  "    ",
  "}",
  ")",
  ";",
  "\n",
  "\n",
  "    ",
  "res",
  ".",
  "json",
  "(",
  "{",
  "\n",
  "      ",
  "query",
  ",",
  "\n",
  "      ",
  "result",
  ":",
  " ",
  "response",
  ",",
  "\n",
  "    ",
  "}",
  ")",
  ";",
  "\n",
  "  ",
  "}",
  " ",
  "catch",
  " ",
  "(",
  "error",
  ")",
  " ",
  "{",
  "\n",
  "    ",
  "console",
  ".",
  "error",
  "(",
  "\"Error",
  " ",
  "processing",
  " ",
  "code",
  " ",
  "query",
  ":",
  "\"",
  ",",
  " ",
  "error",
  ")",
  ";",
  "\n",
  "    ",
  "res",
  ".",
  "status",
  "(",
  "500",
  ")",
  ".",
  "json",
  "(",
  "{",
  " ",
  "error",
  ":",
  " ",
  "\"Failed",
  " ",
  "to",
  " ",
  "process",
  " ",
  "query\"",
  " ",
  "}",
  ")",
  ";",
  "\n",
  "  ",
  "}",
  "\n",
  "}",
  ";",
  "\n",
  "\n",
  "/",
  "/",
  " ",
  "Register",
  " ",
  "routes",
  "\n",
  "app",
  ".",
  "get",
  "(",
  "\"",
  "/",
  "\"",
  ",",
  " ",
  "homeHandler",
  " ",
  "as",
  " ",
  "RequestHandler",
  ")",
  ";",
  "\n",
  "app",
  ".",
  "post",
  "(",
  "\"",
  "/",
  "api",
  "/",
  "code",
  "-",
  "query\"",
  ",",
  " ",
  "codeQueryHandler",
  " ",
  "as",
  " ",
  "RequestHandler",
  ")",
  ";",
  "\n",
  "\n",
  "app",
  ".",
  "listen",
  "(",
  "port",
  ",",
  " ",
  "(",
  ")",
  " ",
  "=",
  ">",
  " ",
  "{",
  "\n",
  "  ",
  "console",
  ".",
  "log",
  "(",
  "`Server",
  " ",
  "running",
  " ",
  "at",
  " ",
  "http",
  ":",
  "/",
  "/",
  "localhost",
  ":",
  "$",
  "{",
  "port",
  "}",
  "`",
  ")",
  ";",
  "\n",
  "  ",
  "console",
  ".",
  "log",
  "(",
  "\"Generating",
  " ",
  "codebase",
  " ",
  "index",
  ".",
  ".",
  ".",
  "\"",
  ")",
  ";",
  "\n",
  "  ",
  "/",
  "/",
  " ",
  "generateCodebaseIndex",
  "(",
  ")",
  ";",
  "\n",
  "}",
  ")",
  ";",
  "\n",
  "\n"
]